/**
 * 	jQuery Selector UI Widget 1.0 
 *
 * 	Depends: 
 *	   - jQuery 1.4.2+
 * 	Auther:
 *     - Gavin Li 2012.08.09
 *  Update:
 *     - 2014.02.12
 * 
 *  Reference resources: jquery.multiselect.js (http://www.erichynds.com/jquery/jquery-ui-multiselect-widget)
 * 	Example: 		
		<select name="example" multiple="multiple">
			<option value="option1">Option 1</option>
			<option value="option2" selected="true">Option 2</option>
			<option value="option3">Option 3</option>
		</select>
		
		$('select').filterSelector({
			multiple: false,
			click: function(){
				// todo
			}
		});
 */
(function(b){var a=0;b.extend(b.fn,{filterSelector:function(c){return this.each(function(){var d=b.data(this,"selector");if(!d){d=new b.filterSelector(c,this);b.data(this,"selector",d)}})}});b.filterSelector=function(c,d){if(arguments.length){this.init(c,d)}};b.filterSelector.prototype={eventPrefix:"",escape:/[\-\[\]{}()*+?.,\\\^$|#\s]/g,isOpen:false,checkAllFlag:false,minWidth:50,disabled:false,options:{header:true,width:false,height:false,style:"",checkAllText:"Check all / Uncheck all",noneSelectedText:"Select options",selectedText:"# selected",displaySelectedText:false,selectedList:2,multiple:true,filter:false,groupSelected:false},init:function(c,d){var e=(this.options=b.extend(true,{},this.options,c));this.element=b(d);this.selector=b("<span />").addClass("selector").addClass(e.filter===true?"selector-filter":"").attr({title:this.element.attr("title"),style:e.style}).insertAfter(this.element),this.input=b("<input "+(e.filter!==true?'readonly="true"':"")+" ></input>").addClass("selector-input").appendTo(this.selector),this.button=b('<a href="#"></a>').addClass("selector-button").appendTo(this.selector),this.menu=b("<div />").addClass("selector-menu").appendTo(document.body);if(e.header!==false){this.header=b("<div />").addClass("selector-menu-header").appendTo(this.menu),this.headerLinkContainer=b("<ul />").html(function(){var f="";if(typeof e.header==="string"){f+="<li>"+e.header+"</li>"}else{if(e.header===true&&e.multiple===true){f+='<li><a class="selector-menu-checklink" href="#"><span>'+e.checkAllText+"</span></a></li>"}}f+='<li class="li-close"><a href="#" class="selector-menu-close"><span class="icon-close"/></a></li>';return f}).appendTo(this.header)}this.checkboxContainer=b("<div />").addClass("selector-menu-list").addClass(e.multiple?"":"selector-menu-single").append("<ul />").appendTo(this.menu);this.checkboxContainer.find("ul").height(e.height);this.build();this.cacheData();this.bindEvents();this._trigger("create")},build:function(){var d=this.element,e=this.options,c="",f=a++;d.attr("multiple","multiple").hide();d.find("option").each(function(j){var n=this.parentNode,l=this.innerHTML,o=this.title,m=this.value,h="selector-"+f+"-option-"+j,p=this.disabled,g=this.selected,k=[];if(p){k.push("item-disabled")}if(g&&!e.multiple){k.push("item-active")}c+="<li>";c+='<label for="'+h+'" title="'+o+'" class="'+k.join(" ")+'">';c+='<input id="'+h+'" name="selector_'+f+'" type="'+(e.multiple?"checkbox":"radio")+'" value="'+m+'" title="'+l+'"';if(g){c+=' checked="checked"'}if(p){c+=' disabled="disabled"'}c+=" /><span>"+l+"</span></label></li>"});this.checkboxContainer.find("ul").html(c);this.labels=this.checkboxContainer.find("label");this.inputs=this.checkboxContainer.find("input");this.setSelectorWidth();this.setMenuWidth();this.button[0].defaultValue=this.update()},update:function(k){var e=this.options,d=this.checkboxContainer,c=this.inputs,f=c.filter(":checked"),h=c.length,l=f.length,m;k||b("li.group-line",d).remove();if(l===0){m=e.noneSelectedText}else{if(b.isFunction(e.selectedText)){m=e.selectedText.call(this,l,h,f.get())}else{if(/\d/.test(e.selectedList)&&e.selectedList>0&&l<=e.selectedList){m=f.map(function(){return b(this).next().html()}).get().join(", ")}else{m=e.selectedText.replace("#",l).replace("#",h)}}if(!k&&e.multiple===true&&e.groupSelected===true&&l!==h){if(l<=h/2){b("li:first",d).before('<li class="group-line"></li>');var g;for(var j=0;j<c.length;j++){g=c[j];if(g.checked===true){b("li:first",d).before(b(g).closest("li"))}}}else{b("ul",d).append('<li class="group-line"></li>');var g;for(var j=0;j<c.length;j++){g=c[j];if(g.checked===false){b("ul",d).append(b(g).closest("li"))}}}}}if(e.displaySelectedText===true||l===0||e.multiple===false){this.input.val(m)}return m},bindEvents:function(){var e=this,c=this.selector,d=this.input,f=this.button,g=this.options;if(g.filter===true){d.bind({keydown:function(h){if(h.which===13){h.preventDefault();return}},keyup:function(){e._filter()},focus:function(){c.hasClass("selector-disabled")||(d.toggleClass("selector-input-active",true),d.val(""),e.open())}})}else{d.bind({click:function(){c.hasClass("selector-disabled")||(d.toggleClass("selector-input-active",true),f.trigger("click"))}})}f.bind({click:function(h){h.preventDefault(),e[e.isOpen?"close":"open"]()}});if(g.header!==false){this.header.delegate("a","click.selector",function(h){h.preventDefault();if(b(this).hasClass("selector-menu-close")){e.close()}else{if(b(this).hasClass("selector-menu-checklink")){e._toggleChecked((e.checkAllFlag=!e.checkAllFlag))}}})}this.checkboxContainer.delegate("label","mouseenter.selector",function(){if(!b(this).is(".item-disabled, .group-line")){e.labels.removeClass("item-hover");b(this).addClass("item-hover").find("input").focus()}}).delegate("label","keydown.selector",function(h){h.preventDefault();switch(h.which){case 9:case 27:e.close();break;case 38:case 40:case 37:case 39:e._traverse(h.which,this);break;case 13:b(this).find("input")[0].click();break}}).delegate('input[type="checkbox"], input[type="radio"]',"click.selector",function(m){var o=this.value,l=this.checked,j=e.element.find("option"),n,h;if(this.disabled||e._trigger("click",m,{value:o,text:this.title,checked:l})===false){m.preventDefault();return}for(var k=0;k<j.length;k++){n=j[k];if(n.value===o){n.selected=l}else{if(!g.multiple){n.selected=false}}}if(g.multiple===true){e._trigger("change");setTimeout(b.proxy(e.update,e),10)}else{h=b(this).closest("label"),h.hasClass("item-active")||(e.labels.removeClass("item-active"),h.toggleClass("item-active",l),e._trigger("change"),setTimeout(b.proxy(e.update,e),10));e.close()}});b(document).bind("mousedown.selector",function(h){if(e.isOpen&&!b.contains(e.menu[0],h.target)&&h.target!==e.button[0]&&h.target!==e.input[0]){e.close()}})},open:function(){if(this.disabled||this.isOpen||this._trigger("beforeopen")===false){return}var d=this.input,h=this.menu,g=this.options,f=b(window),c=f.height(),i=d.offset(),e=i.top+d.outerHeight()+1;this.checkboxContainer.scrollTop(0);h.css({top:c-e>h.outerHeight()?e:i.top-h.outerHeight()-1,left:i.left,display:"block"});this.input.addClass("selector-input-active");this.button.addClass("selector-button-active");this.isOpen=true;this._trigger("open")},close:function(){if(this.isOpen===false||this._trigger("beforeclose")===false){return}this.menu.hide();this.options.filter===true&&this.items.show();this.update(true);this.input.removeClass("selector-input-active");this.button.removeClass("selector-button-active");this.isOpen=false;this._trigger("close")},_toggleChecked:function(c){var d=this,e=this.inputs.filter(function(){return !this.disabled&&b.css(b(this).parents("li")[0],"display")!=="none"});e.attr("checked",c===true);this.update();this.element.find("option").attr("selected",c===true);if(e.length){this._trigger("change")}},getSelectedText:function(){if(this.options.multiple===true){$checked=this.inputs.filter(":checked");return $checked.map(function(){return b(this).attr("title")}).get().join(",")}return this.inputs.filter(":checked").attr("title")},getSelectedValue:function(){if(this.options.multiple===true){$checked=this.inputs.filter(":checked");return $checked.map(function(){return b(this).val()}).get().join(",")}return this.inputs.filter(":checked").val()},setSelectedOptions:function(m){if(m===undefined||m===null){return}var g=(""+m).split(","),l=g.slice(0),k=this.inputs,n=this.element.find("option"),h=this.labels;n.attr("selected",false),k.attr("checked",false),h.removeClass("item-hover");if(this.options.multiple!==true){var c=':[value="'+g[g.length-1]+'"]';h.removeClass("item-active");n.filter(c).attr("selected",true),k.filter(c).attr("checked",true).closest("label").addClass("item-active")}else{var e;for(var f=0;f<k.length&&g.length>0;f++){e=k[f];for(var d=0;d<g.length;d++){if(e.value===g[d]){e.checked=true;g.splice(d,1);break}}}setTimeout(function(){for(var p=0;p<n.length&&l.length>0;p++){e=n[p];for(var o=0;o<l.length;o++){if(e.value===l[o]){e.selected=true;l.splice(o,1);break}}}},0)}this.update()},disableSelector:function(c){this.close(),this.selector.toggleClass("selector-disabled",c===true),this.disabled=(c===true)},disableOptions:function(l,c){if(l===undefined||l===null){return}var h=this.inputs,m=this.element.find("option"),g=(""+l).split(","),k=g.slice(0),e;for(var f=0;f<h.length&&g.length>0;f++){e=h[f];for(var d=0;d<g.length;d++){if(e.value===g[d]){b(e).attr("disabled",c===true).closest("label").toggleClass("item-disabled",c===true);g.splice(d,1);break}}}setTimeout(function(){for(var o=0;o<m.length&&k.length>0;o++){e=m[o];for(var n=0;n<k.length;n++){if(e.value===k[n]){e.disabled=(c===true);k.splice(n,1);break}}}},0)},setSelectorWidth:function(){var c=this.options.width;if(/\d/.test(c)&&c>=this.minWidth){this.input.width(c)}},setMenuWidth:function(){var c=this.menu,d=this.input.outerWidth()-parseInt(c.css("padding-left"),10)-parseInt(c.css("padding-right"),10)-parseInt(c.css("border-right-width"),10)-parseInt(c.css("border-left-width"),10);c.width(d||this.input.outerWidth())},cacheData:function(){this.items=this.checkboxContainer.find("li:not(.group-line)");this.cache=this.element.children().map(function(){return b(this).map(function(){return this.innerHTML.toLowerCase()}).get()}).get()},getInputValue:function(){return b.trim(this.input.val())},_filter:function(i){var g=this.getInputValue(),f=this.items,c=this.inputs,d=this.cache;if(!g){f.show()}else{f.hide();var h=new RegExp(g.toLowerCase().replace(this.escape,"\\$&"),"gi");this._trigger("filter",i,b.map(d,function(e,j){if(e.search(h)!==-1){f.eq(j).show();return c.get(j)}return null}))}if(!this.isOpen){if(!g&&c.filter(":checked").length>0){this.update()}this.open()}},_traverse:function(g,h){var e=b(h),d=g===38||g===37,c=e.parent()[d?"prevAll":"nextAll"](":not(.item-disabled, .group-line)")[d?"last":"first"]();if(!c.length){var f=this.menu.find("ul:last");f.find("label")[d?"last":"first"]().trigger("mouseover");f.scrollTop(d?f.height():0)}else{c.find("label").trigger("mouseover")}},_trigger:function(c,d,e){var h,g,f=this.options[c];e=e||{};d=b.Event(d);d.type=(c===this.eventPrefix?c:this.eventPrefix+c).toLowerCase();d.target=this.element[0];g=d.originalEvent;if(g){for(h in g){if(!(h in d)){d[h]=g[h]}}}this.element.trigger(d,e);return !(b.isFunction(f)&&f.call(this.element[0],d,e)===false||d.isDefaultPrevented())}};b.extend(b.fn,{getSelectedText:function(){var c=this.data("selector");return c?(c.getSelectedText()||""):""},getSelectedValue:function(){var c=this.data("selector");return c?(c.getSelectedValue()||""):""},setSelectedOptions:function(d){var c=this.data("selector");return c&&c.setSelectedOptions(d),this},disableSelector:function(d){var c=this.data("selector");return c&&c.disableSelector(d),this},refreshSelector:function(){var c=this.data("selector");return c&&(c.build(),c.cacheData()),this},disableOptions:function(e,d){var c=this.data("selector");return c&&c.disableOptions(e,d),this}})})(jQuery);
